SELECT EMPRESTO

GOTO TOP

LOCATE FOR CODIGO = VCODIGO

IF .NOT. FOUND()
TEL61:=SAVESCREEN(09,13,14,65)
SETCOLOR(_COR4)
@ 09,23 CLEAR TO 11,53
@ 09,23 TO 11,53 DOUBLE
@ 10,25 SAY TEXTO11
TONE(1000,1)
INKEY(0)
RESTSCREEN(09,13,14,65,TEL61)
SETCOLOR(COR)
RETURN(0)
ELSE
*
ENDIF

TEL61:=SAVESCREEN(05,01,21,80)
COR:=SETCOLOR(_COR1)

SETCURSOR(1)

@ 05,01 CLEAR TO 19,79
@ 05,02 TO 19,79 DOUBLE

@ 05,30 SAY TEXTO10
@ 06,03 SAY 'Nome da pessoa: '
@ 08,03 SAY 'Titulo: '
@ 10,03 SAY 'Conjunto: '
@ 12,03 SAY 'Saiu em: '
@ 14,03 SAY 'Retornou em: '
@ 16,03 SAY 'Midia:'
@ 18,03 SAY 'Codigo:'

VRETORNOU:=DATE()

@ 14,15 GET VRETORNOU
setcolor('w+/b')
@ 06,18 SAY NOME
@ 08,10 SAY TITULO
@ 10,12 SAY CONJUNTO
@ 12,11 SAY SAIU
@ 16,09 SAY VMIDIA
@ 18,10 SAY VCODIGO
READ
SETCURSOR(0)

IF LASTKEY()==27
RESTSCREEN(05,01,21,80,TEL61)
SETCOLOR(COR)
RETURN(2)
ENDIF

IF Pergunta("Voce confirma a devolu‡„o? (S/N)",Cor4)<>"S"
   RESTSCREEN(05,01,21,80,TEL61)
   RETURN
ENDIF

VNOME:=NOME
NCONJUNTO:=CONJUNTO
VSAIU:=SAIU
IF SAIU = CTOD(' / /    ')
VDIAS := 9999999999
ELSE
VDIAS := VRETORNOU - SAIU
ENDIF

SELECT CADASTRO
GOTO TOP
LOCATE FOR REGISTRO = VCODIGO
VTOTAL_EM = TOTAL_EM + 1
REPLACE I_DEVOLVE WITH .T.
REPLACE NEMPRESTO WITH SPACE(32)
REPLACE EMPRESTADO WITH .F.
REPLACE D_SAIU WITH CTOD("00/00/00")
REPLACE TOTAL_EM WITH VTOTAL_EM
dbcommit()

SELECT DEVOLVE
APPEND BLANK
REPLACE NOME WITH VNOME
REPLACE TITULO WITH VTITULO
REPLACE TITULO_C WITH LEFT(TITULO,36)
REPLACE CONJUNTO WITH VCONJUNTO
REPLACE SAIU WITH VSAIU
REPLACE RETORNOU WITH VRETORNOU
REPLACE DIAS WITH VDIAS
REPLACE CODIGO WITH VCODIGO
REPLACE MIDIA WITH VMIDIA
REPLACE REGISTRO WITH RECNO()
dbcommit()

SELECT NOME

SET FILTER TO

GOTO TOP

SET FILTER TO MIDIA = VMIDIA

GOTO TOP

LOCATE FOR NOME = VNOME

IF FOUND()
REPLACE ULT_EMPRE WITH VSAIU
VTOTAL_EM = TOTAL_EM + 1
REPLACE TOTAL_EM WITH VTOTAL_EM
VCOD_NOME = REGISTRO
dbcommit()
SELEC DEVOLVE
REPLACE COD_NOME WITH VCOD_NOME
dbcommit()

ELSE

APPEND BLANK
VTOTAL_EM = TOTAL_EM + 1
REPLACE NOME WITH VNOME
REPLACE REGISTRO WITH RECNO()
REPLACE DATA WITH DATE()
REPLACE MIDIA WITH VMIDIA
REPLACE ULT_EMPRE WITH VSAIU
REPLACE TOTAL_EM WITH VTOTAL_EM
dbcommit()

VCOD_NOME = RECNO()

SELECT DEVOLVE
REPLACE COD_NOME WITH VCOD_NOME
dbcommit()
ENDIF

SELECT EMPRESTO
GOTO TOP
LOCATE FOR CODIGO = VCODIGO
DELETE
dbcommit()
RESTSCREEN(05,01,21,80,TEL61)
RETURN(2)
